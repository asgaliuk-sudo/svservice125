<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVservice125 - Административная панель</title>
    <style>
        :root {
          /* Primitive Color Tokens */
          --color-white: rgba(255, 255, 255, 1);
          --color-black: rgba(0, 0, 0, 1);
          --color-cream-50: rgba(252, 252, 249, 1);
          --color-cream-100: rgba(255, 255, 253, 1);
          --color-gray-200: rgba(245, 245, 245, 1);
          --color-gray-300: rgba(167, 169, 169, 1);
          --color-gray-400: rgba(119, 124, 124, 1);
          --color-slate-500: rgba(98, 108, 113, 1);
          --color-brown-600: rgba(94, 82, 64, 1);
          --color-charcoal-700: rgba(31, 33, 33, 1);
          --color-charcoal-800: rgba(38, 40, 40, 1);
          --color-slate-900: rgba(19, 52, 59, 1);
          --color-teal-300: rgba(50, 184, 198, 1);
          --color-teal-400: rgba(45, 166, 178, 1);
          --color-teal-500: rgba(33, 128, 141, 1);
          --color-teal-600: rgba(29, 116, 128, 1);
          --color-teal-700: rgba(26, 104, 115, 1);
          --color-teal-800: rgba(41, 150, 161, 1);
          --color-red-400: rgba(255, 84, 89, 1);
          --color-red-500: rgba(192, 21, 47, 1);
          --color-orange-400: rgba(230, 129, 97, 1);
          --color-orange-500: rgba(168, 75, 47, 1);
        
          /* RGB versions for opacity control */
          --color-brown-600-rgb: 94, 82, 64;
          --color-teal-500-rgb: 33, 128, 141;
          --color-slate-900-rgb: 19, 52, 59;
          --color-slate-500-rgb: 98, 108, 113;
          --color-red-500-rgb: 192, 21, 47;
          --color-red-400-rgb: 255, 84, 89;
          --color-orange-500-rgb: 168, 75, 47;
          --color-orange-400-rgb: 230, 129, 97;
        
          /* Background color tokens (Light Mode) */
          --color-bg-1: rgba(59, 130, 246, 0.08);
          --color-bg-2: rgba(245, 158, 11, 0.08);
          --color-bg-3: rgba(34, 197, 94, 0.08);
          --color-bg-4: rgba(239, 68, 68, 0.08);
          --color-bg-5: rgba(147, 51, 234, 0.08);
          --color-bg-6: rgba(249, 115, 22, 0.08);
          --color-bg-7: rgba(236, 72, 153, 0.08);
          --color-bg-8: rgba(6, 182, 212, 0.08);
        
          /* Semantic Color Tokens (Light Mode) */
          --color-background: var(--color-cream-50);
          --color-surface: var(--color-cream-100);
          --color-text: var(--color-slate-900);
          --color-text-secondary: var(--color-slate-500);
          --color-primary: var(--color-teal-500);
          --color-primary-hover: var(--color-teal-600);
          --color-primary-active: var(--color-teal-700);
          --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
          --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
          --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
          --color-border: rgba(var(--color-brown-600-rgb), 0.2);
          --color-btn-primary-text: var(--color-cream-50);
          --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
          --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
          --color-error: var(--color-red-500);
          --color-success: var(--color-teal-500);
          --color-warning: var(--color-orange-500);
          --color-info: var(--color-slate-500);
          --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
          --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);
        
          /* Common style patterns */
          --focus-ring: 0 0 0 3px var(--color-focus-ring);
          --focus-outline: 2px solid var(--color-primary);
          --status-bg-opacity: 0.15;
          --status-border-opacity: 0.25;
        
          /* RGB versions for opacity control */
          --color-success-rgb: 33, 128, 141;
          --color-error-rgb: 192, 21, 47;
          --color-warning-rgb: 168, 75, 47;
          --color-info-rgb: 98, 108, 113;
        
          /* Typography */
          --font-family-base: "Arial", sans-serif;
          --font-family-mono: "Courier New", monospace;
          --font-size-xs: 11px;
          --font-size-sm: 12px;
          --font-size-base: 14px;
          --font-size-md: 14px;
          --font-size-lg: 16px;
          --font-size-xl: 18px;
          --font-size-2xl: 20px;
          --font-size-3xl: 24px;
          --font-size-4xl: 30px;
          --font-weight-normal: 400;
          --font-weight-medium: 500;
          --font-weight-semibold: 550;
          --font-weight-bold: 600;
          --line-height-tight: 1.2;
          --line-height-normal: 1.5;
          --letter-spacing-tight: -0.01em;
        
          /* Spacing */
          --space-0: 0;
          --space-1: 1px;
          --space-2: 2px;
          --space-4: 4px;
          --space-6: 6px;
          --space-8: 8px;
          --space-10: 10px;
          --space-12: 12px;
          --space-16: 16px;
          --space-20: 20px;
          --space-24: 24px;
          --space-32: 32px;
        
          /* Border Radius */
          --radius-sm: 6px;
          --radius-base: 8px;
          --radius-md: 10px;
          --radius-lg: 12px;
          --radius-full: 9999px;
        
          /* Shadows */
          --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
          --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
          --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
          --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
          --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.03);
        
          /* Animation */
          --duration-fast: 150ms;
          --duration-normal: 250ms;
          --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
        
          /* Layout */
          --container-sm: 640px;
          --container-md: 768px;
          --container-lg: 1024px;
          --container-xl: 1280px;
        
          /* Custom app colors - Updated according to requirements */
          --app-primary: #2563eb;
          --app-danger: #dc2626;
          --app-background: #f8fafc;
          --app-text: #1e293b;
          --app-success: #059669;
          --app-warning: #d97706;
          --app-secondary: #64748b;
        }
        
        /* Base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html {
            font-size: var(--font-size-base);
            font-family: var(--font-family-base);
            line-height: var(--line-height-normal);
            color: var(--color-text);
            background-color: var(--app-background);
        }
        
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            margin: 0;
            font-weight: var(--font-weight-semibold);
            line-height: var(--line-height-tight);
            color: var(--color-text);
            letter-spacing: var(--letter-spacing-tight);
        }
        
        h1 { font-size: var(--font-size-4xl); }
        h2 { font-size: var(--font-size-3xl); }
        h3 { font-size: var(--font-size-2xl); }
        h4 { font-size: var(--font-size-xl); }
        h5 { font-size: var(--font-size-lg); }
        h6 { font-size: var(--font-size-md); }
        
        /* App specific styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--app-primary) 0%, #1e40af 100%);
        }
        
        .login-form {
            background: var(--color-surface);
            padding: var(--space-32);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 400px;
            margin: var(--space-16);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: var(--space-32);
        }
        
        .login-header h1 {
            color: var(--app-primary);
            margin-bottom: var(--space-8);
        }
        
        .login-header p {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }
        
        .form-group {
            margin-bottom: var(--space-16);
        }
        
        .form-label {
            display: block;
            margin-bottom: var(--space-8);
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-sm);
            color: var(--color-text);
        }
        
        .form-control {
            display: block;
            width: 100%;
            padding: var(--space-12);
            font-size: var(--font-size-md);
            line-height: 1.5;
            color: var(--color-text);
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            transition: border-color var(--duration-fast) var(--ease-standard), box-shadow var(--duration-fast) var(--ease-standard);
        }
        
        .form-control:focus {
            border-color: var(--color-primary);
            outline: var(--focus-outline);
        }
        
        .form-check {
            display: flex;
            align-items: center;
            gap: var(--space-8);
            margin-bottom: var(--space-16);
        }
        
        .form-check input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--app-primary);
        }
        
        .form-check label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            cursor: pointer;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-12) var(--space-20);
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-weight: 500;
            line-height: 1.5;
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
            border: none;
            text-decoration: none;
            position: relative;
        }
        
        .btn:focus-visible {
            outline: none;
            box-shadow: var(--focus-ring);
        }
        
        .btn--primary {
            background: var(--app-primary);
            color: var(--color-btn-primary-text);
        }
        
        .btn--primary:hover {
            background: #1d4ed8;
        }
        
        .btn--primary:active {
            background: #1e3a8a;
        }
        
        .btn--secondary {
            background: var(--color-secondary);
            color: var(--color-text);
        }
        
        .btn--secondary:hover {
            background: var(--color-secondary-hover);
        }
        
        .btn--danger {
            background: var(--app-danger);
            color: var(--color-white);
        }
        
        .btn--danger:hover {
            background: #b91c1c;
        }
        
        .btn--danger:active {
            background: #991b1b;
        }
        
        .btn--success {
            background: var(--app-success);
            color: var(--color-white);
        }
        
        .btn--success:hover {
            background: #047857;
        }
        
        .btn--warning {
            background: var(--app-warning);
            color: var(--color-white);
        }
        
        .btn--warning:hover {
            background: #b45309;
        }
        
        .btn--full-width {
            width: 100%;
        }
        
        .btn--sm {
            padding: var(--space-6) var(--space-12);
            font-size: var(--font-size-sm);
        }
        
        .btn--xs {
            padding: var(--space-4) var(--space-8);
            font-size: var(--font-size-xs);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Main app layout */
        .app-container {
            min-height: 100vh;
            background: var(--app-background);
        }
        
        .app-header {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: var(--space-16) var(--space-24);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .app-logo {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--app-primary);
        }
        
        .app-nav {
            display: flex;
            gap: var(--space-24);
        }
        
        .nav-item {
            padding: var(--space-8) var(--space-16);
            cursor: pointer;
            border-radius: var(--radius-base);
            transition: background var(--duration-fast);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
        }
        
        .nav-item:hover {
            background: var(--color-secondary);
            color: var(--color-text);
        }
        
        .nav-item.active {
            background: var(--app-primary);
            color: var(--color-white);
        }
        
        .app-content {
            padding: var(--space-24);
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Calendar styles */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-24);
        }
        
        .calendar-navigation {
            display: flex;
            align-items: center;
            gap: var(--space-16);
        }
        
        .calendar-month {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            min-width: 200px;
            text-align: center;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--color-border);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            overflow: hidden;
        }
        
        .calendar-day-header {
            background: var(--color-secondary);
            padding: var(--space-12);
            text-align: center;
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            color: var(--color-text);
        }
        
        .calendar-day {
            background: var(--color-surface);
            min-height: 120px;
            padding: var(--space-8);
            cursor: pointer;
            transition: background var(--duration-fast);
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .calendar-day:hover {
            background: var(--color-bg-1);
        }
        
        .calendar-day.other-month {
            background: var(--color-gray-200);
            color: var(--color-text-secondary);
        }
        
        .calendar-day.today {
            background: var(--color-bg-3);
            font-weight: var(--font-weight-bold);
        }
        
        .day-number {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--space-4);
        }
        
        .day-appointments {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .appointment-item {
            background: var(--app-primary);
            color: var(--color-white);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-sm);
            font-size: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            transition: all var(--duration-fast);
        }
        
        .appointment-item:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }
        
        .appointment-count {
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            background: var(--app-primary);
            color: var(--color-white);
            border-radius: var(--radius-full);
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: var(--font-weight-bold);
        }
        
        .floating-btn {
            position: fixed;
            bottom: var(--space-24);
            right: var(--space-24);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--app-primary);
            color: var(--color-white);
            border: none;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            font-size: var(--font-size-2xl);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform var(--duration-fast);
        }
        
        .floating-btn:hover {
            transform: scale(1.05);
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            padding: var(--space-24);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: var(--font-size-2xl);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-base);
            transition: background var(--duration-fast);
        }
        
        .modal-close:hover {
            background: var(--color-secondary);
        }
        
        .modal-body {
            padding: var(--space-24);
        }
        
        .modal-footer {
            padding: var(--space-24);
            border-top: 1px solid var(--color-border);
            display: flex;
            justify-content: flex-end;
            gap: var(--space-12);
        }
        
        /* Form styles */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-16);
        }
        
        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }
        
        /* Table styles */
        .table-container {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th,
        .table td {
            padding: var(--space-12);
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }
        
        .table th {
            background: var(--color-secondary);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
            cursor: pointer;
            transition: background var(--duration-fast);
        }
        
        .table th:hover {
            background: var(--color-secondary-hover);
        }
        
        .table tbody tr {
            cursor: pointer;
            transition: background var(--duration-fast);
        }
        
        .table tbody tr:hover {
            background: var(--color-bg-1);
        }
        
        /* Search and filter styles */
        .search-filters {
            display: flex;
            gap: var(--space-16);
            margin-bottom: var(--space-24);
            flex-wrap: wrap;
        }
        
        .search-input {
            flex: 1;
            min-width: 200px;
        }
        
        /* Contact buttons */
        .contact-buttons {
            display: flex;
            gap: var(--space-8);
            margin-top: var(--space-16);
        }
        
        .btn-call {
            background: #22c55e;
            color: var(--color-white);
        }
        
        .btn-whatsapp {
            background: #25d366;
            color: var(--color-white);
        }
        
        .btn-telegram {
            background: #0088cc;
            color: var(--color-white);
        }
        
        /* Birthday section */
        .birthday-section {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            margin-bottom: var(--space-24);
        }
        
        .birthday-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-16);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-12);
        }
        
        .birthday-info h4 {
            margin-bottom: var(--space-4);
        }
        
        .birthday-info p {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            margin: 0;
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            top: var(--space-24);
            right: var(--space-24);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-16);
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            max-width: 400px;
            transform: translateX(100%);
            transition: transform var(--duration-normal);
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            border-color: var(--color-success);
        }
        
        .toast.error {
            border-color: var(--color-error);
        }
        
        .toast.warning {
            border-color: var(--color-warning);
        }
        
        .toast-content {
            display: flex;
            align-items: center;
            gap: var(--space-12);
        }
        
        .toast-icon {
            font-size: var(--font-size-lg);
        }
        
        .toast-message {
            flex: 1;
        }
        
        .toast-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
        }
        
        /* Loading styles */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-32);
        }
        
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--color-border);
            border-top-color: var(--app-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive styles */
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                gap: var(--space-16);
            }
            
            .app-nav {
                justify-content: center;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .calendar-day {
                min-height: 80px;
            }
            
            .search-filters {
                flex-direction: column;
            }
        }
        
        /* Hidden class */
        .hidden {
            display: none !important;
        }
        
        /* Form validation styles */
        .form-control.error {
            border-color: var(--app-danger) !important;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }
        
        .field-error {
            color: var(--app-danger);
            font-size: var(--font-size-xs);
            margin-top: var(--space-4);
            display: block;
        }
        
        /* Client type selection */
        .client-type-selection {
            display: flex;
            gap: var(--space-8);
            margin-bottom: var(--space-24);
        }
        
        .client-type-btn {
            flex: 1;
        }
        
        .client-type-btn.active {
            background: var(--app-primary);
            color: var(--color-white);
        }
        
        /* Search results */
        .search-results {
            position: relative;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
        }
        
        .search-result-item {
            padding: var(--space-12);
            cursor: pointer;
            border-bottom: 1px solid var(--color-border);
            transition: background var(--duration-fast);
        }
        
        .search-result-item:hover {
            background: var(--color-bg-1);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-result-name {
            font-weight: var(--font-weight-medium);
        }
        
        .search-result-details {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }
        
        /* Statistics styles */
        .stats-filters {
            display: flex;
            flex-direction: column;
            gap: var(--space-16);
            margin-bottom: var(--space-24);
            padding: var(--space-20);
            background: var(--color-surface);
            border-radius: var(--radius-lg);
        }
        
        .quick-filters {
            display: flex;
            gap: var(--space-8);
            flex-wrap: wrap;
        }
        
        .date-filters {
            display: flex;
            gap: var(--space-12);
            align-items: center;
            flex-wrap: wrap;
        }
        
        .date-filters label {
            font-weight: var(--font-weight-medium);
            min-width: 24px;
        }
        
        .date-filters input {
            width: 150px;
        }
        
        .stats-display {
            display: flex;
            flex-direction: column;
            gap: var(--space-24);
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-16);
        }
        
        .stat-card {
            background: var(--color-surface);
            padding: var(--space-24);
            border-radius: var(--radius-lg);
            text-align: center;
            border: 1px solid var(--color-border);
        }
        
        .stat-value {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--app-primary);
            margin-bottom: var(--space-8);
        }
        
        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            font-weight: var(--font-weight-medium);
        }
        
        .stats-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-24);
        }
        
        .stats-section {
            background: var(--color-surface);
            padding: var(--space-24);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
        }
        
        .stats-section h3 {
            margin-bottom: var(--space-16);
        }
        
        .top-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-12);
        }
        
        .top-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-12);
            background: var(--color-bg-1);
            border-radius: var(--radius-base);
        }
        
        .top-item-rank {
            font-weight: var(--font-weight-bold);
            color: var(--color-text);
        }

        /* Appointment card */
        .appointment-card {
            display: flex;
            flex-direction: column;
            gap: var(--space-8);
        }

        .appointment-time {
            font-weight: var(--font-weight-bold);
        }

        .appointment-client {
            color: var(--app-primary);
        }

        .appointment-actions {
            display: flex;
            gap: var(--space-8);
            justify-content: flex-end;
        }

        /* Mobile optimizations */
        @media (max-width: 600px) {
            .modal-content {
                width: 100%;
                max-width: none;
                border-radius: 0;
            }

            .modal-footer {
                flex-direction: column;
                gap: var(--space-8);
            }

            .modal-footer .btn {
                width: 100%;
            }

            .contact-buttons {
                flex-direction: column;
                gap: var(--space-8);
            }

            .contact-buttons .btn {
                width: 100%;
            }

            .appointment-actions {
                flex-direction: column;
            }

            .appointment-actions .btn {
                width: 100%;
            }

            .floating-btn {
                bottom: var(--space-16);
                right: var(--space-16);
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="loginContainer" class="login-container">
        <form class="login-form" id="loginForm">
            <div class="login-header">
                <h1>SVservice125</h1>
                <p>Административная панель</p>
            </div>
            <div class="form-group">
                <label class="form-label" for="login">Логин</label>
                <input type="text" class="form-control" id="login" placeholder="Введите логин" required>
            </div>
            <div class="form-group">
                <label class="form-label" for="password">Пароль</label>
                <input type="password" class="form-control" id="password" placeholder="Введите пароль" required>
            </div>
            <button type="submit" class="btn btn--primary btn--full-width">Войти</button>
            <div class="form-check">
                <input type="checkbox" id="rememberMe">
                <label for="rememberMe">Запомнить меня</label>
            </div>
        </form>
    </div>

    <div id="appContainer" class="app-container hidden">
        <header class="app-header">
            <div class="app-logo">SVservice125</div>
            <nav class="app-nav">
                <div class="nav-item active" data-tab="calendar">Календарь</div>
                <div class="nav-item" data-tab="clients">Клиенты</div>
                <div class="nav-item" data-tab="birthdays">Дни рождения</div>
                <div class="nav-item" data-tab="statistics">Статистика</div>
            </nav>
            <button id="logoutBtn" class="btn btn--secondary">Выйти</button>
        </header>
        <main class="app-content">
            <div id="calendarTab">
                <div class="calendar-header">
                    <div class="calendar-navigation">
                        <button class="btn btn--sm" id="prevMonth">&lt;</button>
                        <div class="calendar-month" id="currentMonth"></div>
                        <button class="btn btn--sm" id="nextMonth">&gt;</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <div class="calendar-day-header">Пн</div>
                    <div class="calendar-day-header">Вт</div>
                    <div class="calendar-day-header">Ср</div>
                    <div class="calendar-day-header">Чт</div>
                    <div class="calendar-day-header">Пт</div>
                    <div class="calendar-day-header">Сб</div>
                    <div class="calendar-day-header">Вс</div>
                </div>
                <button class="floating-btn" id="addAppointmentBtn">+</button>
            </div>
            <div id="clientsTab" class="hidden">
                <div class="search-filters">
                    <input type="text" class="form-control search-input" id="searchInput" placeholder="Поиск по ФИО, телефону...">
                    <select class="form-control" id="carBrandFilter">
                        <option value="">Все марки</option>
                    </select>
                </div>
                <div class="table-container">
                    <table class="table" id="clientsTable">
                        <thead>
                            <tr>
                                <th data-sort="fio">ФИО</th>
                                <th data-sort="phone">Телефон</th>
                                <th data-sort="car_brand">Марка авто</th>
                                <th data-sort="car_number">Номер авто</th>
                                <th data-sort="visit_datetime">Последний визит</th>
                                <th data-sort="total_visits">Визиты</th>
                                <th data-sort="total_sum">Сумма</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div id="birthdaysTab" class="hidden">
                <div class="birthday-section">
                    <h3>Сегодня</h3>
                    <div id="todayBirthdaysList"></div>
                </div>
                <div class="birthday-section">
                    <h3>Ближайшие 7 дней</h3>
                    <div id="upcomingBirthdaysList"></div>
                </div>
            </div>
            <div id="statisticsTab" class="hidden">
                <div class="stats-filters">
                    <div class="quick-filters">
                        <button class="btn btn--secondary btn--xs" data-period="today">Сегодня</button>
                        <button class="btn btn--secondary btn--xs" data-period="week">Неделя</button>
                        <button class="btn btn--secondary btn--xs" data-period="month">Месяц</button>
                        <button class="btn btn--secondary btn--xs" data-period="year">Год</button>
                    </div>
                    <div class="date-filters">
                        <label for="statsFrom">С</label>
                        <input type="date" id="statsFrom" class="form-control">
                        <label for="statsTo">По</label>
                        <input type="date" id="statsTo" class="form-control">
                        <button class="btn btn--primary btn--xs" id="applyStatsFilter">Применить</button>
                    </div>
                </div>
                <div class="stats-display">
                    <div class="stats-cards">
                        <div class="stat-card">
                            <div class="stat-value" id="totalRevenue">0 ₽</div>
                            <div class="stat-label">Общая выручка</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="newClients">0</div>
                            <div class="stat-label">Новые клиенты</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="repeatClients">0</div>
                            <div class="stat-label">Повторные клиенты</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="averageCheck">0 ₽</div>
                            <div class="stat-label">Средний чек</div>
                        </div>
                    </div>
                    <div class="stats-details">
                        <div class="stats-section">
                            <h3>Топ услуг</h3>
                            <div class="top-list" id="topServices"></div>
                        </div>
                        <div class="stats-section">
                            <h3>Топ автомобилей</h3>
                            <div class="top-list" id="topCars"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="appointmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Запись</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="appointmentForm" class="modal-body">
                <div class="client-type-selection">
                    <button type="button" class="btn btn--secondary client-type-btn active" data-type="new">Новый клиент</button>
                    <button type="button" class="btn btn--secondary client-type-btn" data-type="existing">Существующий</button>
                </div>
                <div id="existingClientSearch" class="form-group hidden">
                    <label class="form-label" for="clientSearch">Поиск клиента</label>
                    <input type="text" class="form-control" id="clientSearch" placeholder="Введите ФИО или телефон">
                    <div id="clientSearchResults" class="search-results hidden"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="clientFio">ФИО</label>
                        <input type="text" class="form-control" id="clientFio" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="clientPhone">Телефон</label>
                        <input type="tel" class="form-control" id="clientPhone" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="clientBirthdate">Дата рождения</label>
                        <input type="date" class="form-control" id="clientBirthdate">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="carBrand">Марка авто</label>
                        <input type="text" class="form-control" id="carBrand">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="carNumber">Номер авто</label>
                        <input type="text" class="form-control" id="carNumber">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="mileage">Пробег</label>
                        <input type="number" class="form-control" id="mileage">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="vin">VIN</label>
                        <input type="text" class="form-control" id="vin">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="visitDate">Дата визита</label>
                        <input type="date" class="form-control" id="visitDate" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="visitTimeStart">Время начала</label>
                        <select class="form-control" id="visitTimeStart" required></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="visitTimeEnd">Время окончания</label>
                        <select class="form-control" id="visitTimeEnd" required></select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="serviceDescription">Описание услуги</label>
                    <textarea class="form-control" id="serviceDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="orderSum">Сумма заказа</label>
                    <input type="number" class="form-control" id="orderSum" step="0.01">
                </div>
            </form>
            <div class="modal-footer">
                <button class="btn btn--secondary" id="cancelAppointmentBtn">Отмена</button>
                <button class="btn btn--primary" id="saveAppointmentBtn">Сохранить</button>
                <button class="btn btn--danger hidden" id="deleteAppointmentBtn">Удалить</button>
                <button class="btn btn--secondary hidden" id="editClientDataBtn">Редактировать данные клиента</button>
            </div>
        </div>
    </div>

    <div id="dayAppointmentsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="dayModalTitle">Записи на день</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="dayAppointmentsList"></div>
            <div class="modal-footer">
                <button class="btn btn--secondary modal-close">Закрыть</button>
                <button class="btn btn--primary" id="addNewOnDayBtn">Добавить новую</button>
            </div>
        </div>
    </div>

    <div id="appointmentDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Детали записи</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="appointmentDetailsBody"></div>
            <div class="modal-footer">
                <button class="btn btn--secondary modal-close">Закрыть</button>
                <button class="btn btn--primary" id="editAppointmentBtn">Отредактировать</button>
                <button class="btn btn--danger" id="deleteAppointmentBtn">Удалить</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://qldvhnkrjsnwqnpmjdog.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFsZHZobmtyanNud3FucG1qZG9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MTE4NzAsImV4cCI6MjA3NzE4Nzg3MH0.cMPGxHx52AjCjeIkubAMgvsBQNPEdrexSvl4T4JRdXc';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const HARDCODED_USERS = [{ login: 'admin', password: 'admin' }];
        let clients = [];
        let currentMonth = new Date();
        let selectedDate = null;
        let selectedAppointmentId = null;
        let clientType = 'new';
        let selectedClientData = null;
        let sortColumn = null;
        let sortDirection = 'asc';
        let clientSearchTimeout = null;
        const timeSlots = [
            '09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30',
            '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30',
            '17:00', '17:30', '18:00', '18:30', '19:00', '19:30', '20:00'
        ];

        // Supabase functions
        async function loadClientsFromSupabase() {
            try {
                const { data, error } = await supabaseClient.from('clients').select('*').order('visit_date', { ascending: false });
                if (error) throw error;
                clients = data || [];
            } catch (error) {
                console.error('Error loading clients:', error);
                showToast('Ошибка загрузки данных клиентов', 'error');
            }
        }

        async function addClientToSupabase(clientData) {
            try {
                const { data, error } = await supabaseClient.from('clients').insert([clientData]).select();
                if (error) throw error;
                return data[0];
            } catch (error) {
                console.error('Error adding client:', error);
                showToast('Ошибка добавления записи: ' + (error.message || 'Неизвестная ошибка'), 'error');
                throw error;
            }
        }

        async function updateClientInSupabase(id, updates) {
            try {
                const { data, error } = await supabaseClient.from('clients').update(updates).eq('id', id).select();
                if (error) throw error;
                return data[0];
            } catch (error) {
                console.error('Error updating client:', error);
                showToast('Ошибка обновления записи: ' + (error.message || 'Неизвестная ошибка'), 'error');
                throw error;
            }
        }

        async function deleteClientFromSupabase(id) {
            try {
                const { error } = await supabaseClient.from('clients').delete().eq('id', id);
                if (error) throw error;
            } catch (error) {
                console.error('Error deleting client:', error);
                showToast('Ошибка удаления записи: ' + (error.message || 'Неизвестная ошибка'), 'error');
                throw error;
            }
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            const loginContainer = document.getElementById('loginContainer');
            const appContainer = document.getElementById('appContainer');
            const loginForm = document.getElementById('loginForm');

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const login = document.getElementById('login').value;
                const password = document.getElementById('password').value;
                const user = checkLogin(login, password);
                if (user) {
                    loginContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    initApp();
                } else {
                    showToast('Неверный логин или пароль', 'error');
                }
            });

            document.getElementById('logoutBtn').addEventListener('click', () => {
                appContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                loginForm.reset();
            });

            // Nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    e.target.classList.add('active');
                    const tab = e.target.dataset.tab;
                    document.querySelectorAll('.app-content > div').forEach(t => t.classList.add('hidden'));
                    document.getElementById(tab + 'Tab').classList.remove('hidden');
                    if (tab === 'clients') renderClients();
                    if (tab === 'birthdays') renderBirthdays();
                    if (tab === 'statistics') renderStatistics();
                });
            });

            // Calendar navigation
            document.getElementById('prevMonth').addEventListener('click', () => {
                currentMonth.setMonth(currentMonth.getMonth() - 1);
                renderCalendar();
            });
            document.getElementById('nextMonth').addEventListener('click', () => {
                currentMonth.setMonth(currentMonth.getMonth() + 1);
                renderCalendar();
            });

            // Add appointment
            document.getElementById('addAppointmentBtn').addEventListener('click', openAppointmentModal);

            // Modal close
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', closeModals);
            });

            // Appointment form
            const appointmentForm = document.getElementById('appointmentForm');
            appointmentForm.addEventListener('submit', (e) => e.preventDefault());

            document.getElementById('saveAppointmentBtn').addEventListener('click', saveAppointment);

            document.getElementById('cancelAppointmentBtn').addEventListener('click', closeModals);

            document.getElementById('deleteAppointmentBtn').addEventListener('click', deleteAppointment);

            document.getElementById('editClientDataBtn').addEventListener('click', enableClientDataEdit);

            // Client type buttons
            document.querySelectorAll('.client-type-btn').forEach(btn => {
                btn.addEventListener('click', (e) => switchClientType(e.target.dataset.type));
            });

            // Client search
            document.getElementById('clientSearch').addEventListener('input', handleClientSearch);

            // Form validation
            appointmentForm.querySelectorAll('.form-control[required]').forEach(field => {
                field.addEventListener('blur', validateField);
                field.addEventListener('focus', clearFieldError);
            });

            // Phone formatting
            document.getElementById('clientPhone').addEventListener('input', formatPhoneNumber);

            // Clients filters
            document.getElementById('searchInput').addEventListener('input', renderClients);
            document.getElementById('carBrandFilter').addEventListener('change', renderClients);

            // Table sorting
            document.querySelectorAll('.table th[data-sort]').forEach(th => {
                th.addEventListener('click', () => sortTable(th.dataset.sort));
            });

            // Statistics filters
            document.querySelectorAll('.quick-filters button').forEach(btn => {
                btn.addEventListener('click', (e) => applyQuickFilter(e.target.dataset.period));
            });
            document.getElementById('applyStatsFilter').addEventListener('click', renderStatistics);

            // Time selection
            document.getElementById('visitTimeStart').addEventListener('change', updateEndTimes);

            // Add new on day
            document.getElementById('addNewOnDayBtn').addEventListener('click', () => {
                closeModals();
                openAppointmentModal();
            });

            // Edit appointment from details
            document.getElementById('editAppointmentBtn').addEventListener('click', () => {
                const appointment = clients.find(c => c.id === selectedAppointmentId);
                closeModals();
                openAppointmentModal(appointment);
            });
        });

        async function initApp() {
            showLoading();
            await loadClientsFromSupabase();
            renderCalendar();
            populateTimeSlots();
            populateCarBrandFilter();
            renderBirthdays();
            renderStatistics();
            hideLoading();
        }

        // Calendar rendering
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = `
                <div class="calendar-day-header">Пн</div>
                <div class="calendar-day-header">Вт</div>
                <div class="calendar-day-header">Ср</div>
                <div class="calendar-day-header">Чт</div>
                <div class="calendar-day-header">Пт</div>
                <div class="calendar-day-header">Сб</div>
                <div class="calendar-day-header">Вс</div>
            `;
            document.getElementById('currentMonth').textContent = currentMonth.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
            const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1).getDay() === 0 ? 7 : new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1).getDay();
            const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
            const prevMonthDays = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 0).getDate();

            for (let i = firstDay - 2; i >= 0; i--) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.innerHTML = `<div class="day-number">${prevMonthDays - i}</div>`;
                grid.appendChild(day);
            }

            for (let dayNum = 1; dayNum <= daysInMonth; dayNum++) {
                const day = document.createElement('div');
                day.className = 'calendar-day';
                const dateStr = formatDateForComparison(new Date(currentMonth.getFullYear(), currentMonth.getMonth(), dayNum));
                const dayAppointments = clients.filter(a => a.visit_date === dateStr).sort((a, b) => a.visit_time_start.localeCompare(b.visit_time_start));
                if (dayAppointments.length > 0) {
                    day.innerHTML = `
                        <div class="day-number">${dayNum}</div>
                        <div class="day-appointments">
                            ${dayAppointments.slice(0, 3).map(a => `<div class="appointment-item" data-id="${a.id}">${a.visit_time_start} ${a.fio.split(' ')[0]}</div>`).join('')}
                        </div>
                        ${dayAppointments.length > 3 ? `<div class="appointment-count">+${dayAppointments.length - 3}</div>` : ''}
                    `;
                } else {
                    day.innerHTML = `<div class="day-number">${dayNum}</div>`;
                }
                if (dateStr === formatDateForComparison(new Date())) day.classList.add('today');
                day.addEventListener('click', () => {
                    selectedDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), dayNum);
                    if (dayAppointments.length > 0) {
                        showDayAppointments(dayAppointments, dateStr);
                    } else {
                        openAppointmentModal();
                    }
                });
                grid.appendChild(day);
            }
        }

        function showDayAppointments(appointments, dateStr) {
            const modal = document.getElementById('dayAppointmentsModal');
            const title = document.getElementById('dayModalTitle');
            const list = document.getElementById('dayAppointmentsList');

            title.textContent = `Записи на ${formatDateForDisplay(dateStr)}`;

            list.innerHTML = appointments.map(a => `
                <div class="appointment-card" data-id="${a.id}" style="background: var(--color-bg-1); padding: var(--space-12); border-radius: var(--radius-base); margin-bottom: var(--space-12); cursor: pointer;">
                    <div class="appointment-time">${a.visit_time_start} - ${a.visit_time_end}</div>
                    <div class="appointment-client">${a.fio}</div>
                    <div class="appointment-details">
                        <div><strong>Авто:</strong> ${a.car_brand} ${a.car_number}</div>
                        <div><strong>Услуга:</strong> ${a.service_description || 'Не указано'}</div>
                        <div><strong>Сумма:</strong> ${a.order_sum || 0} ₽</div>
                    </div>
                    <div class="appointment-actions">
                        <button class="btn btn--sm btn--primary edit-btn" data-id="${a.id}">Отредактировать</button>
                        <button class="btn btn--sm btn--danger delete-btn" data-id="${a.id}">Удалить</button>
                    </div>
                </div>
            `).join('');

            list.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = e.target.dataset.id;
                    const appointment = appointments.find(a => a.id === id);
                    closeModals();
                    openAppointmentModal(appointment);
                });
            });

            list.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = e.target.dataset.id;
                    if (confirm('Удалить эту запись?')) {
                        deleteClientFromSupabase(id).then(() => {
                            loadClientsFromSupabase().then(() => {
                                closeModals();
                                renderCalendar();
                                if (document.querySelector('.nav-item.active').dataset.tab === 'clients') renderClients();
                            });
                        });
                    }
                });
            });

            list.querySelectorAll('.appointment-card').forEach(card => {
                card.addEventListener('click', () => {
                    selectedAppointmentId = card.dataset.id;
                    const appointment = appointments.find(a => a.id === selectedAppointmentId);
                    showAppointmentDetails(appointment);
                });
            });

            modal.classList.add('show');
        }

        function showAppointmentDetails(appointment) {
            const modal = document.getElementById('appointmentDetailsModal');
            const body = document.getElementById('appointmentDetailsBody');
            const editBtn = document.getElementById('editAppointmentBtn');
            const deleteBtn = document.getElementById('deleteAppointmentBtn');

            body.innerHTML = `
                <div class="form-group">
                    <strong>Дата и время:</strong> ${getAppointmentTimeDisplay(appointment)}
                </div>
                <div class="form-group">
                    <strong>ФИО:</strong> ${appointment.fio}
                </div>
                <div class="form-group">
                    <strong>Телефон:</strong> ${appointment.phone}
                    <div class="contact-buttons">
                        <a href="tel:${appointment.phone}" class="btn btn--sm btn-call">📞 Позвонить</a>
                        <a href="https://wa.me/${appointment.phone}" target="_blank" class="btn btn--sm btn-whatsapp">💬 WhatsApp</a>
                        <a href="https://t.me/${appointment.phone}" target="_blank" class="btn btn--sm btn-telegram">✈️ Telegram</a>
                    </div>
                </div>
                <div class="form-group">
                    <strong>Дата рождения:</strong> ${appointment.birthdate || 'Не указано'}
                </div>
                <div class="form-group">
                    <strong>Автомобиль:</strong> ${appointment.car_brand} ${appointment.car_number}
                </div>
                <div class="form-group">
                    <strong>Пробег:</strong> ${appointment.mileage || 'Не указано'}
                </div>
                <div class="form-group">
                    <strong>VIN:</strong> ${appointment.vin || 'Не указано'}
                </div>
                <div class="form-group">
                    <strong>Услуга:</strong> ${appointment.service_description || 'Не указано'}
                </div>
                <div class="form-group">
                    <strong>Сумма:</strong> ${appointment.order_sum || 0} ₽
                </div>
            `;

            editBtn.style.display = 'inline-flex';
            deleteBtn.style.display = 'inline-flex';

            modal.classList.add('show');
        }

        // Appointment modal
        function openAppointmentModal(appointment = null) {
            const modal = document.getElementById('appointmentModal');
            const title = modal.querySelector('.modal-title');
            const form = document.getElementById('appointmentForm');
            const deleteBtn = document.getElementById('deleteAppointmentBtn');
            const editClientBtn = document.getElementById('editClientDataBtn');

            form.reset();
            clientType = 'new';
            selectedClientData = null;
            switchClientType('new');

            if (appointment) {
                title.textContent = 'Редактировать запись';
                selectedAppointmentId = appointment.id;
                document.getElementById('clientFio').value = appointment.fio;
                document.getElementById('clientPhone').value = appointment.phone;
                document.getElementById('clientBirthdate').value = appointment.birthdate;
                document.getElementById('carBrand').value = appointment.car_brand;
                document.getElementById('carNumber').value = appointment.car_number;
                document.getElementById('mileage').value = appointment.mileage;
                document.getElementById('vin').value = appointment.vin;
                document.getElementById('serviceDescription').value = appointment.service_description;
                document.getElementById('orderSum').value = appointment.order_sum;
                document.getElementById('visitDate').value = appointment.visit_date;
                document.getElementById('visitTimeStart').value = appointment.visit_time_start;
                document.getElementById('visitTimeEnd').value = appointment.visit_time_end;
                deleteBtn.classList.remove('hidden');
                switchClientType('existing');
                selectedClientData = appointment;
                editClientBtn.classList.remove('hidden');
                toggleFormFields(false);
                updateEndTimes();
            } else {
                title.textContent = 'Новая запись';
                selectedAppointmentId = null;
                deleteBtn.classList.add('hidden');
                editClientBtn.classList.add('hidden');
                if (selectedDate) {
                    document.getElementById('visitDate').value = formatDateForInput(selectedDate);
                }
            }

            populateTimeSlots();
            modal.classList.add('show');
        }

        function updateEndTimes() {
            const startTime = document.getElementById('visitTimeStart').value;
            const endSelect = document.getElementById('visitTimeEnd');
            endSelect.innerHTML = '<option value="">Выберите время</option>';
            if (!startTime) {
                endSelect.disabled = true;
                return;
            }
            endSelect.disabled = false;
            const startIndex = timeSlots.indexOf(startTime);
            for (let i = startIndex + 1; i < timeSlots.length; i++) {
                const option = document.createElement('option');
                option.value = timeSlots[i];
                option.textContent = timeSlots[i];
                endSelect.appendChild(option);
            }
        }

        async function saveAppointment() {
            const form = document.getElementById('appointmentForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const data = {
                fio: document.getElementById('clientFio').value,
                phone: document.getElementById('clientPhone').value,
                birthdate: document.getElementById('clientBirthdate').value || null,
                car_brand: document.getElementById('carBrand').value,
                car_number: document.getElementById('carNumber').value,
                mileage: document.getElementById('mileage').value,
                vin: document.getElementById('vin').value,
                service_description: document.getElementById('serviceDescription').value,
                order_sum: parseFloat(document.getElementById('orderSum').value) || 0,
                visit_date: document.getElementById('visitDate').value,
                visit_time_start: document.getElementById('visitTimeStart').value,
                visit_time_end: document.getElementById('visitTimeEnd').value
            };

            try {
                if (selectedAppointmentId) {
                    await updateClientInSupabase(selectedAppointmentId, data);
                    showToast('Запись обновлена', 'success');
                } else {
                    await addClientToSupabase(data);
                    showToast('Запись добавлена', 'success');
                }
                closeModals();
                await loadClientsFromSupabase();
                renderCalendar();
                populateCarBrandFilter();
                renderBirthdays();
                if (document.querySelector('.nav-item.active').dataset.tab === 'clients') renderClients();
                if (document.querySelector('.nav-item.active').dataset.tab === 'statistics') renderStatistics();
            } catch (error) {
                showToast('Ошибка сохранения: ' + (error.message || 'Неизвестная ошибка'), 'error');
            }
        }

        async function deleteAppointment() {
            if (!confirm('Удалить эту запись?')) return;
            try {
                await deleteClientFromSupabase(selectedAppointmentId);
                showToast('Запись удалена', 'success');
                closeModals();
                await loadClientsFromSupabase();
                renderCalendar();
                populateCarBrandFilter();
                renderBirthdays();
                if (document.querySelector('.nav-item.active').dataset.tab === 'clients') renderClients();
                if (document.querySelector('.nav-item.active').dataset.tab === 'statistics') renderStatistics();
            } catch (error) {
                showToast('Ошибка удаления: ' + (error.message || 'Неизвестная ошибка'), 'error');
            }
        }

        // Clients rendering
        function renderClients() {
            const tableBody = document.querySelector('#clientsTable tbody');
            const uniqueClients = filterAndSortUniqueClients(getUniqueClientsWithStats());
            tableBody.innerHTML = uniqueClients.map(client => `
                <tr data-client-phone="${client.phone || ''}">
                    <td>${client.fio || 'Не указано'}</td>
                    <td>${client.phone || 'Не указано'}</td>
                    <td>${client.car_brand || 'Не указано'}</td>
                    <td>${client.car_number || 'Не указано'}</td>
                    <td>${formatDateForDisplay(formatDateForComparison(client.lastVisit))}</td>
                    <td>${client.totalVisits}</td>
                    <td>${client.totalSum} ₽</td>
                </tr>
            `).join('');

            tableBody.querySelectorAll('tr').forEach(row => {
                row.addEventListener('click', () => showClientHistory(getUniqueClientsWithStats().find(c => c.phone === row.dataset.clientPhone)));
            });
            if (uniqueClients.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--color-text-secondary);">Нет клиентов</td></tr>';
            }
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            renderClients();
        }

        // Birthdays
        function renderBirthdays() {
            renderTodayBirthdays();
            renderUpcomingBirthdays();
        }

        function renderTodayBirthdays() {
            const container = document.getElementById('todayBirthdaysList');
            const today = new Date();
            
            const uniqueClients = getUniqueClientsWithStats();
            
            const todayBirthdays = uniqueClients.filter(client => {
                if (!client.birthdate) return false;
                const birthDate = parseBirthdate(client.birthdate);
                return birthDate.getMonth() === today.getMonth() && 
                       birthDate.getDate() === today.getDate();
            });
            
            if (todayBirthdays.length === 0) {
                container.innerHTML = '<p style="color: var(--color-text-secondary);">Сегодня нет именинников</p>';
                return;
            }

            container.innerHTML = '<p>🎉 <strong>Сегодня день рождения у следующих клиентов:</strong></p>';
            
            todayBirthdays.forEach(client => {
                const age = calculateAge(parseBirthdate(client.birthdate));
                const birthdayItem = document.createElement('div');
                birthdayItem.className = 'birthday-item';
                
                birthdayItem.innerHTML = `
                    <div class="birthday-info">
                        <h4>${client.fio}</h4>
                        <p>${client.phone} • ${age} лет</p>
                    </div>
                    <div class="contact-buttons">
                        <a href="tel:${client.phone}" class="btn btn--sm btn-call">📞</a>
                        <a href="https://wa.me/${client.phone}" target="_blank" class="btn btn--sm btn-whatsapp">💬</a>
                        <a href="https://t.me/${client.phone}" target="_blank" class="btn btn--sm btn-telegram">✈️</a>
                    </div>
                `;
                
                container.appendChild(birthdayItem);
            });
        }

        function renderUpcomingBirthdays() {
            const container = document.getElementById('upcomingBirthdaysList');
            const today = new Date();
            const upcomingBirthdays = [];
            
            const uniqueClients = getUniqueClientsWithStats();
            
            uniqueClients.forEach(client => {
                if (!client.birthdate) return;
                
                const birthDate = parseBirthdate(client.birthdate);
                const thisYearBirthday = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());
                
                if (thisYearBirthday < today) {
                    thisYearBirthday.setFullYear(today.getFullYear() + 1);
                }
                
                const daysDiff = Math.ceil((thisYearBirthday - today) / (1000 * 60 * 60 * 24));
                
                if (daysDiff > 0 && daysDiff <= 7) {
                    upcomingBirthdays.push({
                        ...client,
                        daysDiff,
                        nextBirthday: thisYearBirthday
                    });
                }
            });
            
            upcomingBirthdays.sort((a, b) => a.daysDiff - b.daysDiff);
            
            if (upcomingBirthdays.length === 0) {
                container.innerHTML = '<p style="color: var(--color-text-secondary);">Нет именинников на ближайшие 7 дней</p>';
                return;
            }
            
            container.innerHTML = '';
            
            upcomingBirthdays.forEach(client => {
                const age = calculateAge(parseBirthdate(client.birthdate));
                const birthdayItem = document.createElement('div');
                birthdayItem.className = 'birthday-item';
                
                const dayText = client.daysDiff === 1 ? 'завтра' : `через ${client.daysDiff} дней`;
                
                birthdayItem.innerHTML = `
                    <div class="birthday-info">
                        <h4>${client.fio}</h4>
                        <p>${client.phone} • ${age + 1} лет (${dayText})</p>
                    </div>
                    <div class="contact-buttons">
                        <a href="tel:${client.phone}" class="btn btn--sm btn-call">📞</a>
                        <a href="https://wa.me/${client.phone}" target="_blank" class="btn btn--sm btn-whatsapp">💬</a>
                        <a href="https://t.me/${client.phone}" target="_blank" class="btn btn--sm btn-telegram">✈️</a>
                    </div>
                `;
                
                container.appendChild(birthdayItem);
            });
        }

        // Utility functions
        function closeModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('show');
            });
        }

        function populateTimeSlots() {
            const startSelect = document.getElementById('visitTimeStart');
            const endSelect = document.getElementById('visitTimeEnd');
            
            startSelect.innerHTML = '<option value="">Выберите время</option>';
            endSelect.innerHTML = '<option value="">Выберите время</option>';
            
            timeSlots.forEach(time => {
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                startSelect.appendChild(option.cloneNode(true));
                endSelect.appendChild(option);
            });
        }

        function getAppointmentTimeDisplay(appointment) {
            if (appointment.visit_time_start && appointment.visit_time_end) {
                const duration = calculateDuration(appointment.visit_time_start, appointment.visit_time_end);
                const date = appointment.visit_date || formatDateForComparison(new Date(appointment.visit_datetime));
                return `${formatDateForDisplay(date)} ${appointment.visit_time_start} - ${appointment.visit_time_end} (${duration})`;
            } else if (appointment.visit_datetime) {
                return formatDateTime(new Date(appointment.visit_datetime));
            }
            return 'Время не указано';
        }

        function calculateDuration(startTime, endTime) {
            const start = new Date(`2000-01-01T${startTime}:00`);
            const end = new Date(`2000-01-01T${endTime}:00`);
            const diffMs = end - start;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            
            if (diffHours === 0) {
                return `${diffMinutes} мин`;
            } else if (diffMinutes === 0) {
                return `${diffHours} ч`;
            } else {
                return `${diffHours} ч ${diffMinutes} мин`;
            }
        }

        function formatPhoneNumber(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length > 0 && !value.startsWith('7')) {
                if (value.startsWith('8')) {
                    value = '7' + value.slice(1);
                } else {
                    value = '7' + value;
                }
            }
            
            if (value.length > 11) {
                value = value.slice(0, 11);
            }
            
            e.target.value = '+' + value;
        }
        
        // Form field validation
        function validateField(e) {
            const field = e.target;
            const value = field.value.trim();
            
            // Remove existing error styling
            field.classList.remove('error');
            
            if (field.hasAttribute('required') && !value) {
                showFieldError(field, 'Обязательное поле');
                return false;
            }
            
            // Phone validation
            if (field.id === 'clientPhone') {
                const phoneRegex = /^\+7\d{10}$/;
                if (value && !phoneRegex.test(value)) {
                    showFieldError(field, 'Неверный формат телефона');
                    return false;
                }
            }
            
            // Number validation
            if (field.type === 'number' && value) {
                if (parseFloat(value) < 0) {
                    showFieldError(field, 'Значение не может быть отрицательным');
                    return false;
                }
            }
            
            return true;
        }
        
        function showFieldError(field, message) {
            field.classList.add('error');
            
            // Remove existing error message
            const existingError = field.parentNode.querySelector('.field-error');
            if (existingError) {
                existingError.remove();
            }
            
            // Add error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'field-error';
            errorDiv.style.cssText = 'color: var(--app-danger); font-size: var(--font-size-xs); margin-top: var(--space-4);';
            errorDiv.textContent = message;
            field.parentNode.appendChild(errorDiv);
        }
        
        function clearFieldError(e) {
            const field = e.target;
            field.classList.remove('error');
            const errorDiv = field.parentNode.querySelector('.field-error');
            if (errorDiv) {
                errorDiv.remove();
            }
        }

        function formatDateForComparison(date) {
            return date.toISOString().split('T')[0];
        }

        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        function formatBirthdateForInput(birthdate) {
            if (!birthdate) return '';
            const parts = birthdate.split('.');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            }
            return birthdate;
        }

        function formatBirthdateForStorage(date) {
            if (!date) return null;
            return date;
        }

        function parseBirthdate(birthdate) {
            if (!birthdate) return new Date();
            const parts = birthdate.split('-');
            if (parts.length === 3) {
                return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            }
            return new Date(birthdate);
        }

        function formatTime(date) {
            return date.toTimeString().slice(0, 5);
        }

        function formatDateTime(date) {
            if (typeof date === 'string') {
                date = new Date(date);
            }
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${day}.${month}.${year} ${hours}:${minutes}`;
        }

        function formatDateForDisplay(dateStr) {
            const parts = dateStr.split('-');
            return `${parts[2]}.${parts[1]}.${parts[0]}`;
        }

        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }

        function calculateAge(birthDate) {
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }

        function checkLogin(login, password) {
            return HARDCODED_USERS.find(u => u.login === login && u.password === password) || null;
        }

        // Toast notifications
        function showToast(message, type = 'success') {
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? '✅' : type === 'warning' ? '⚠️' : '❌';
            
            toast.innerHTML = `
                <div class="toast-content">
                    <div class="toast-icon">${icon}</div>
                    <div class="toast-message">${message}</div>
                    <button class="toast-close">&times;</button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 3000);
            
            // Close button
            toast.querySelector('.toast-close').addEventListener('click', () => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            });
        }

        // Loading indicator
        function showLoading() {
            const existingLoader = document.querySelector('.loading');
            if (existingLoader) return;
            
            const loader = document.createElement('div');
            loader.className = 'loading';
            loader.innerHTML = '<div class="spinner"></div>';
            
            document.body.appendChild(loader);
        }

        function hideLoading() {
            const loader = document.querySelector('.loading');
            if (loader) {
                loader.remove();
            }
        }

        // Client type switching
        function switchClientType(type) {
            clientType = type;
            selectedClientData = null;
            
            // Update button states
            document.querySelectorAll('.client-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
            
            // Clear form when switching types
            if (type === 'new') {
                document.getElementById('appointmentForm').reset();
                if (selectedDate) {
                    document.getElementById('visitDate').value = formatDateForInput(selectedDate);
                }
            }
            
            // Show/hide search
            const searchSection = document.getElementById('existingClientSearch');
            const searchInput = document.getElementById('clientSearch');
            const searchResults = document.getElementById('clientSearchResults');
            
            if (type === 'existing') {
                searchSection.classList.remove('hidden');
                searchInput.focus();
            } else {
                searchSection.classList.add('hidden');
                searchInput.value = '';
                searchResults.innerHTML = '';
            }
            
            // Enable/disable form fields based on type
            toggleFormFields(type === 'new');
        }
        
        // Client search functionality
        function handleClientSearch(e) {
            const query = e.target.value.trim().toLowerCase();
            const resultsContainer = document.getElementById('clientSearchResults');
            
            if (clientSearchTimeout) {
                clearTimeout(clientSearchTimeout);
            }
            
            if (query.length < 2) {
                resultsContainer.innerHTML = '';
                return;
            }
            
            clientSearchTimeout = setTimeout(() => {
                const uniqueClients = getUniqueClientsWithStats();
                const matches = uniqueClients.filter(client => 
                    (client.fio && client.fio.toLowerCase().includes(query)) ||
                    (client.phone && client.phone.toLowerCase().includes(query))
                ).slice(0, 10);
                
                if (matches.length === 0) {
                    resultsContainer.innerHTML = '<div class="search-result-item">Клиенты не найдены</div>';
                    return;
                }
                
                resultsContainer.innerHTML = matches.map(client => `
                    <div class="search-result-item" data-client-id="${client.phone || client.id}">
                        <div class="search-result-name">${client.fio || 'Не указано'}</div>
                        <div class="search-result-details">${client.phone || 'Не указано'} • ${client.car_brand || 'Не указано'} ${client.car_number || ''}</div>
                    </div>
                `).join('');
                
                // Add click handlers
                resultsContainer.querySelectorAll('.search-result-item').forEach(item => {
                    const clientPhone = item.dataset.clientId;
                    if (clientPhone) {
                        item.addEventListener('click', () => {
                            selectExistingClient(clientPhone);
                        });
                    }
                });
            }, 300);
        }
        
        // Select existing client
        function selectExistingClient(clientId) {
            const uniqueClients = getUniqueClientsWithStats();
            const client = uniqueClients.find(c => (c.phone || c.id) === clientId);
            
            if (client) {
                selectedClientData = client;
                
                // Fill form with client data
                document.getElementById('clientFio').value = client.fio || '';
                document.getElementById('clientPhone').value = client.phone || '';
                document.getElementById('clientBirthdate').value = client.birthdate || '';
                document.getElementById('carBrand').value = client.car_brand || '';
                document.getElementById('carNumber').value = client.car_number || '';
                document.getElementById('mileage').value = client.mileage || '';
                document.getElementById('vin').value = client.vin || '';
                
                // Clear search
                document.getElementById('clientSearch').value = client.fio || '';
                document.getElementById('clientSearchResults').innerHTML = '';
                
                // Disable client data fields
                toggleFormFields(false);
                
                // Show edit button
                document.getElementById('editClientDataBtn').classList.remove('hidden');
            }
        }
        
        // Toggle form field states
        function toggleFormFields(enabled) {
            const fields = ['clientFio', 'clientPhone', 'clientBirthdate', 'carBrand', 'carNumber', 'mileage', 'vin'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (enabled) {
                    field.removeAttribute('disabled');
                } else {
                    field.setAttribute('disabled', 'disabled');
                }
            });
        }
        
        // Enable client data editing
        function enableClientDataEdit() {
            toggleFormFields(true);
            document.getElementById('editClientDataBtn').classList.add('hidden');
            showToast('Редактирование данных клиента включено', 'success');
        }
        
        // Get unique clients with statistics
        function getUniqueClientsWithStats() {
            const clientMap = new Map();
            
            clients.forEach(client => {
                const key = client.phone || client.id || Math.random().toString(); // Handle null phone
                if (!clientMap.has(key)) {
                    let visitDate;
                    if (client.visit_date) {
                        visitDate = new Date(client.visit_date);
                    } else if (client.visit_datetime) {
                        visitDate = new Date(client.visit_datetime);
                    } else {
                        visitDate = new Date();
                    }
                    
                    clientMap.set(key, {
                        ...client,
                        totalVisits: 0,
                        totalSum: 0,
                        lastVisit: visitDate
                    });
                }
                
                const existing = clientMap.get(key);
                existing.totalVisits++;
                existing.totalSum += parseFloat(client.order_sum) || 0;
                
                let visitDate;
                if (client.visit_date) {
                    visitDate = new Date(client.visit_date);
                } else if (client.visit_datetime) {
                    visitDate = new Date(client.visit_datetime);
                } else {
                    visitDate = new Date();
                }
                
                if (visitDate > existing.lastVisit) {
                    existing.lastVisit = visitDate;
                    // Update with latest data
                    existing.fio = client.fio;
                    existing.car_brand = client.car_brand;
                    existing.car_number = client.car_number;
                    existing.mileage = client.mileage;
                    existing.vin = client.vin;
                }
            });
            
            return Array.from(clientMap.values());
        }
        
        // Filter and sort unique clients
        function filterAndSortUniqueClients(clients) {
            let filtered = [...clients];
            
            // Search filter
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(client => 
                    (client.fio && client.fio.toLowerCase().includes(searchTerm)) ||
                    (client.phone && client.phone.toLowerCase().includes(searchTerm))
                );
            }
            
            // Car brand filter
            const carBrand = document.getElementById('carBrandFilter').value;
            if (carBrand) {
                filtered = filtered.filter(client => 
                    client.car_brand === carBrand
                );
            }
            
            // Sorting
            if (sortColumn) {
                filtered.sort((a, b) => {
                    let valueA, valueB;
                    
                    switch (sortColumn) {
                        case 'visit_datetime':
                            valueA = new Date(a.lastVisit);
                            valueB = new Date(b.lastVisit);
                            break;
                        case 'total_visits':
                            valueA = a.totalVisits;
                            valueB = b.totalVisits;
                            break;
                        case 'total_sum':
                            valueA = a.totalSum;
                            valueB = b.totalSum;
                            break;
                        default:
                            valueA = (a[sortColumn] || '').toString().toLowerCase();
                            valueB = (b[sortColumn] || '').toString().toLowerCase();
                    }
                    
                    if (valueA < valueB) return sortDirection === 'asc' ? -1 : 1;
                    if (valueA > valueB) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            return filtered;
        }
        
        // Show client history
        function showClientHistory(client) {
            const modal = document.getElementById('appointmentDetailsModal');
            const title = modal.querySelector('.modal-title');
            const body = document.getElementById('appointmentDetailsBody');
            
            title.textContent = `История клиента: ${client.fio || 'Не указано'}`;
            
            // Get all visits for this client
            const clientVisits = clients.filter(c => (c.phone || c.id) === (client.phone || client.id))
                .sort((a, b) => new Date(b.visit_datetime || b.visit_date) - new Date(a.visit_datetime || a.visit_date));
            
            body.innerHTML = `
                <div class="form-group">
                    <strong>ФИО:</strong> ${client.fio || 'Не указано'}
                </div>
                <div class="form-group">
                    <strong>Телефон:</strong> ${client.phone || 'Не указано'}
                    ${client.phone ? `
                    <div class="contact-buttons">
                        <a href="tel:${client.phone}" class="btn btn--sm btn-call">📞 Позвонить</a>
                        <a href="https://wa.me/${client.phone}" target="_blank" class="btn btn--sm btn-whatsapp">💬 WhatsApp</a>
                        <a href="https://t.me/${client.phone}" target="_blank" class="btn btn--sm btn-telegram">✈️ Telegram</a>
                    </div>
                    ` : ''}
                </div>
                <div class="form-group">
                    <strong>Дата рождения:</strong> ${formatDateForDisplay(client.birthdate) || 'Не указано'}
                </div>
                <div class="form-group">
                    <strong>Автомобиль:</strong> ${client.car_brand || 'Не указано'} ${client.car_number || ''}
                </div>
                <div class="form-group">
                    <strong>Всего визитов:</strong> ${client.totalVisits}
                </div>
                <div class="form-group">
                    <strong>Общая сумма:</strong> ${client.totalSum} ₽
                </div>
                <div class="form-group">
                    <strong>История визитов:</strong>
                    <div class="table-container" style="margin-top: 12px;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Дата и время</th>
                                    <th>Услуга</th>
                                    <th>Сумма</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${clientVisits.map(visit => `
                                    <tr data-visit-id="${visit.id || visit.visit_datetime}" style="cursor: pointer;">
                                        <td>${getAppointmentTimeDisplay(visit)}</td>
                                        <td>${visit.service_description || 'Не указано'}</td>
                                        <td>${visit.order_sum || 0} ₽</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Hide edit/delete buttons for client history
            document.getElementById('editAppointmentBtn').style.display = 'none';
            document.getElementById('deleteAppointmentBtn').style.display = 'none';
            
            modal.classList.add('show');
        }

        // Statistics
        function renderStatistics() {
            const fromDate = document.getElementById('statsFrom').value;
            const toDate = document.getElementById('statsTo').value;
            let filtered = clients.filter(c => {
                const visitDate = new Date(c.visit_date || c.visit_datetime);
                if (fromDate && visitDate < new Date(fromDate)) return false;
                if (toDate && visitDate > new Date(toDate + 'T23:59:59')) return false;
                return true;
            });

            const totalRevenue = filtered.reduce((sum, c) => sum + (parseFloat(c.order_sum) || 0), 0);
            const uniqueClients = new Set(filtered.map(c => c.phone)).size;
            const repeatClients = filtered.filter(c => c.totalVisits > 1).length;
            const newClients = uniqueClients - repeatClients;
            const averageCheck = filtered.length > 0 ? totalRevenue / filtered.length : 0;

            document.getElementById('totalRevenue').textContent = `${totalRevenue.toLocaleString()} ₽`;
            document.getElementById('newClients').textContent = newClients;
            document.getElementById('repeatClients').textContent = repeatClients;
            document.getElementById('averageCheck').textContent = `${averageCheck.toFixed(2)} ₽`;

            // Top services and cars would require aggregation, but since no groups, skip or implement if needed
        }

        function applyQuickFilter(period) {
            const today = new Date();
            let fromDate, toDate;
            switch (period) {
                case 'today':
                    fromDate = toDate = formatDateForInput(today);
                    break;
                case 'week':
                    fromDate = formatDateForInput(new Date(today.setDate(today.getDate() - 7)));
                    toDate = formatDateForInput(new Date());
                    break;
                case 'month':
                    fromDate = formatDateForInput(new Date(today.getFullYear(), today.getMonth(), 1));
                    toDate = formatDateForInput(today);
                    break;
                case 'year':
                    fromDate = formatDateForInput(new Date(today.getFullYear(), 0, 1));
                    toDate = formatDateForInput(today);
                    break;
            }
            document.getElementById('statsFrom').value = fromDate;
            document.getElementById('statsTo').value = toDate;
            renderStatistics();
        }

        function populateCarBrandFilter() {
            const select = document.getElementById('carBrandFilter');
            const brands = [...new Set(clients.map(c => c.car_brand).filter(Boolean))];
            
            // Keep existing selection
            const currentValue = select.value;
            
            // Clear and repopulate
            select.innerHTML = '<option value="">Все марки</option>';
            
            brands.sort().forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                select.appendChild(option);
            });
            
            // Restore selection
            select.value = currentValue;
        }
    </script>
</body>
</html>